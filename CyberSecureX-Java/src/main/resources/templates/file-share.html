<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="${title}">File Sharing</title>
    <style>
      :root {
        --primary-bg: #0a0a0a;
        --secondary-bg: #111111;
        --card-bg: rgba(15, 15, 25, 0.9);
        --accent-neon: #00ff41;
        --accent-blue: #00d4ff;
        --text-primary: #ffffff;
        --text-secondary: #b0b0b0;
        --border-glow: rgba(0, 255, 65, 0.3);
        --shadow-neon: 0 0 20px rgba(0, 255, 65, 0.2);
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Orbitron", "Courier Prime", monospace;
        background: var(--primary-bg);
        color: var(--text-primary);
        min-height: 100vh;
        padding: 24px;
        position: relative;
        overflow-x: hidden;
      }
      /* grid background */
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: linear-gradient(
            rgba(0, 255, 65, 0.04) 1px,
            transparent 1px
          ),
          linear-gradient(90deg, rgba(0, 255, 65, 0.04) 1px, transparent 1px);
        background-size: 50px 50px;
        animation: gridMove 20s linear infinite;
        pointer-events: none;
        z-index: -2;
      }
      @keyframes gridMove {
        0% {
          transform: translate(0, 0);
        }
        100% {
          transform: translate(50px, 50px);
        }
      }
      /* floating particles */
      body::after {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
            2px 2px at 20px 30px,
            var(--accent-neon),
            transparent
          ),
          radial-gradient(2px 2px at 40px 70px, var(--accent-blue), transparent);
        background-size: 220px 220px;
        animation: float 14s ease-in-out infinite;
        opacity: 0.12;
        pointer-events: none;
        z-index: -2;
      }
      @keyframes float {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-18px);
        }
      }
      .layout {
        width: 100%;
        max-width: 1000px;
        margin: 0 auto;
        position: relative;
        z-index: 1;
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }
      h1 {
        margin: 0;
        font-size: 24px;
        text-shadow: 0 0 12px var(--accent-neon);
      }
      .link {
        color: var(--accent-blue);
        text-decoration: none;
      }
      .card {
        background: var(--card-bg);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 14px;
        padding: 16px;
        margin-bottom: 16px;
        box-shadow: 0 18px 34px rgba(0, 0, 0, 0.35), var(--shadow-neon);
        backdrop-filter: blur(10px);
      }
      label {
        display: block;
        margin-top: 12px;
        margin-bottom: 6px;
        font-weight: 700;
        color: var(--accent-neon);
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.04);
        color: var(--text-primary);
        font-family: "Courier Prime", monospace;
      }
      /* neon style for selects and options */
      select {
        border-color: rgba(0, 255, 65, 0.35);
        background: rgba(0, 255, 65, 0.06);
      }
      select option {
        background: #0f0f16;
        color: var(--text-primary);
      }
      textarea {
        min-height: 80px;
      }
      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: var(--accent-neon);
        box-shadow: 0 0 12px rgba(0, 255, 65, 0.35);
      }
      button {
        margin-top: 12px;
        padding: 12px 16px;
        border: none;
        border-radius: 10px;
        background: linear-gradient(135deg, var(--accent-neon), #00c94d);
        color: #0b0b11;
        font-weight: 800;
        cursor: pointer;
        box-shadow: 0 10px 20px rgba(0, 255, 65, 0.25);
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .status {
        margin-top: 10px;
        min-height: 18px;
        font-size: 14px;
      }
      .files {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 12px;
      }
      .file {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 12px;
        box-shadow: inset 0 0 18px rgba(255, 255, 255, 0.03);
      }
      .file h3 {
        margin: 0 0 6px 0;
        font-size: 16px;
        color: var(--accent-neon);
      }
      .file small {
        color: var(--text-secondary);
      }
    </style>
  </head>
  <body>
    <div class="layout">
      <header>
        <h1>File Sharing</h1>
        <a class="link" href="/">Logout</a>
      </header>

      <div class="card">
        <h2 style="margin: 0 0 8px 0">Upload</h2>
        <form id="uploadForm">
          <label for="fileInput">File</label>
          <input id="fileInput" type="file" required />

          <label for="description">Description (optional)</label>
          <textarea id="description" placeholder="What is this file?"></textarea>

          <label for="password">Password (optional)</label>
          <input id="password" type="password" placeholder="Leave empty for none" />

          <label for="maxDownloads">Download limit (optional)</label>
          <select id="maxDownloads">
            <option value="">No limit</option>
            <option value="1">1</option>
            <option value="5">5</option>
            <option value="10">10</option>
          </select>

          <label for="expiryHours">Expiry (optional)</label>
          <select id="expiryHours">
            <option value="">Never</option>
            <option value="1">1 hour</option>
            <option value="24">24 hours</option>
            <option value="168">7 days</option>
          </select>

          <button type="submit" id="uploadBtn">Upload</button>
          <div id="status" class="status"></div>
        </form>
      </div>

      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center">
          <h2 style="margin: 0">My Files</h2>
          <button type="button" id="refreshBtn" style="width: auto; padding: 8px 12px">
            Refresh
          </button>
        </div>
        <div id="filesContainer" style="margin-top: 10px">Loading...</div>
      </div>
    </div>

    <script>
      const statusEl = document.getElementById("status");
      const uploadBtn = document.getElementById("uploadBtn");
      const refreshBtn = document.getElementById("refreshBtn");

      function requireToken() {
        const token = localStorage.getItem("authToken");
        if (!token) {
          alert("Login first.");
          window.location.href = "/";
        }
        return token;
      }

      document.getElementById("uploadForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const token = requireToken();
        if (!token) return;

        const fileInput = document.getElementById("fileInput");
        if (!fileInput.files[0]) {
          statusEl.style.color = "#ff6b6b";
          statusEl.textContent = "Select a file.";
          return;
        }
        const password = document.getElementById("password").value.trim();
        if (password && password.length < 4) {
          statusEl.style.color = "#ff6b6b";
          statusEl.textContent = "Password must be at least 4 characters.";
          return;
        }

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);
        const description = document.getElementById("description").value.trim();
        if (description) formData.append("description", description);
        if (password) formData.append("password", password);
        const maxDownloads = document.getElementById("maxDownloads").value;
        if (maxDownloads) formData.append("maxDownloads", maxDownloads);
        const expiryHours = document.getElementById("expiryHours").value;
        if (expiryHours) formData.append("expiryHours", expiryHours);

        uploadBtn.disabled = true;
        statusEl.style.color = "#e8e8e8";
        statusEl.textContent = "Uploading...";

        try {
          const res = await fetch("/api/files/upload", {
            method: "POST",
            headers: { "X-Auth-Token": token },
            body: formData,
          });
          const data = await res.json();
          if (res.ok && data.status === "success") {
            statusEl.style.color = "#3bd671";
            statusEl.textContent = `Uploaded. Share: ${window.location.origin}${data.shareUrl}`;
            e.target.reset();
            loadFiles();
          } else {
            statusEl.style.color = "#ff6b6b";
            statusEl.textContent = data.message || "Upload failed.";
          }
        } catch (err) {
          statusEl.style.color = "#ff6b6b";
          statusEl.textContent = "Network error during upload.";
        } finally {
          uploadBtn.disabled = false;
        }
      });

      async function loadFiles() {
        const token = requireToken();
        if (!token) return;
        const container = document.getElementById("filesContainer");
        container.textContent = "Loading...";
        try {
          const res = await fetch("/api/files/my-files", {
            headers: { "X-Auth-Token": token },
          });
          const files = await res.json();
          if (!Array.isArray(files) || files.length === 0) {
            container.textContent = "No files yet.";
            return;
          }
          container.innerHTML = "";
          const wrapper = document.createElement("div");
          wrapper.className = "files";
          files.forEach((f) => {
            const div = document.createElement("div");
            div.className = "file";
            div.innerHTML = `
              <h3>${f.fileName}</h3>
              <small>Size: ${f.fileSize}</small><br/>
              <small>Uploaded: ${new Date(f.uploadTime).toLocaleString()}</small><br/>
              <small>${f.expiryTime ? "Expires: " + new Date(f.expiryTime).toLocaleString() : "No expiry"}</small><br/>
              <small>${f.maxDownloads > 0 ? "Downloads: " + f.currentDownloads + "/" + f.maxDownloads : "Downloads: " + f.currentDownloads}</small><br/>
              <small>${f.hasPassword ? "Password protected" : "No password"}</small><br/>
              <button style="margin-top:8px;width:100%;" onclick="copyLink('${window.location.origin}/download/${f.shareToken}')">Copy link</button>
            `;
            wrapper.appendChild(div);
          });
          container.appendChild(wrapper);
        } catch (err) {
          container.textContent = "Failed to load files.";
        }
      }

      function copyLink(link) {
        if (navigator.clipboard) {
          navigator.clipboard.writeText(link).then(
            () => alert("Link copied"),
            () => fallbackCopy(link)
          );
        } else {
          fallbackCopy(link);
        }
      }

      function fallbackCopy(text) {
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        alert("Link copied");
      }

      refreshBtn.addEventListener("click", loadFiles);
      loadFiles();
    </script>
  </body>
</html>
